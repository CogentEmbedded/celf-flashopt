#! /bin/bash -e

cd `dirname "$0"`
. common

run_iozone()
{
    #iozone -a -g 3G -f "${mount_dir}/iozone"
    iozone -i 0 -i 1 -i 2 -i 3 -i 4 -i 5 \
        -s 1m -s 16m -s 256m \
        -r 8k -r 64k -r 1m -r 16m -f "${mount_dir}/iozone"
    iozone -i 0 -i 1 -i 2 -i 3 -i 4 -i 5 \
        -s 2g \
        -r 1m -r 16m -f "${mount_dir}/iozone"
}

diff_iozone()
{
    f1=`mktemp`
    egrep '^( *[0-9]+){15,}' "$1" > "${f1}"
    f2=`mktemp`
    egrep '^( *[0-9]+){15,}' "$2" > "${f2}"

    exec 3<"${f1}" 4<"${f2}"
    while read -a first <&3 && read -a second <&4 ; do
        printf "\t%8d %8d" ${first[0]} ${first[1]}
        for (( i = 2 ; i < ${#first[@]} ; ++i )) ; do
            printf ' % 8d' $(( ${second[$i]} - ${first[$i]} ))
            printf ' (%+3d%%)' $(( (${second[$i]} - ${first[$i]}) * 100 / ${first[$i]} ))
        done
        echo
    done
    rm -f "${f1}" "${f2}"
}

case "$1" in
    diff)
        shift
        diff_iozone "$@"
        ;;

    run)
        run_iozone
        ;;
esac
